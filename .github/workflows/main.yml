name: Update 42 Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Update README
        env:
          FT_UID: ${{ secrets.FT_UID }}
          FT_SECRET: ${{ secrets.FT_SECRET }}
        run: |
          python <<EOF
          import os
          import requests
          import re

          def get_token():
              uid = os.getenv('FT_UID')
              secret = os.getenv('FT_SECRET')
              if not uid or not secret:
                  print("Error: Secrets not found")
                  exit(1)
              response = requests.post('https://api.intra.42.fr/oauth/token', data={
                  'grant_type': 'client_credentials',
                  'client_id': uid,
                  'client_secret': secret
              })
              return response.json().get('access_token')

          def get_user_data(token):
              headers = {'Authorization': f'Bearer {token}'}
              response = requests.get('https://api.intra.42.fr/v2/users/sunwkim', headers=headers)
              return response.json()

          try:
              token = get_token()
              data = get_user_data(token)

              # Cursus listì—ì„œ ì •ë³´ ì¶”ì¶œ
              cursus_users = data.get('cursus_users', [])
              # Common Core (id: 21) ìš°ì„ , ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ cursus
              cursus_info = next((c for c in cursus_users if c.get('cursus_id') == 21), cursus_users[-1] if cursus_users else {})

              level = cursus_info.get('level', '0.00')
              blackhole = cursus_info.get('blackhole_expiration_date', 'N/A')
              if blackhole and blackhole != 'N/A':
                  blackhole = blackhole.split('T')[0]

              stats_text = f"### ðŸ“Š 42 Stats (sunwkim)\n- **Level:** {level}\n- **Blackhole:** {blackhole}\n- **Campus:** 42 Lausanne\n"

              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()

              new_content = re.sub(r'.*?', 
                                   f'\n{stats_text}\n', 
                                   content, flags=re.DOTALL)

              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(new_content)
              print("Successfully updated README.md")
          except Exception as e:
              print(f"Error occurred: {e}")
              exit(1)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Update 42 stats" || exit 0
          git push
