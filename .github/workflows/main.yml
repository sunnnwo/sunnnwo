name: Update 42 Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Update README
        env:
          FT_UID: ${{ secrets.FT_UID }}
          FT_SECRET: ${{ secrets.FT_SECRET }}
        run: |
          python -c "
          import os, requests
          
          # 1. í† í° ë° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          uid, secret = os.getenv('FT_UID'), os.getenv('FT_SECRET')
          res = requests.post('https://api.intra.42.fr/oauth/token', data={'grant_type': 'client_credentials', 'client_id': uid, 'client_secret': secret})
          token = res.json().get('access_token')
          user_data = requests.get('https://api.intra.42.fr/v2/users/sunwkim', headers={'Authorization': f'Bearer {token}'}).json()
          
          # 2. ë³¸ê³¼ì •(id: 21) ì •ë³´ ì¶”ì¶œ
          cursus_users = user_data.get('cursus_users', [])
          core = next((c for c in cursus_users if c.get('cursus_id') == 21), cursus_users[-1] if cursus_users else {})
          
          level = core.get('level', '0.00')
          bh = (core.get('blackhole_expiration_date') or 'Completed').split('T')[0]
          
          # 3. íŒŒì¼ ë‚´ìš© ì‘ì„± (ê¸°ì¡´ ë‚´ìš© ë¬´ì‹œí•˜ê³  ìƒˆë¡œ ìƒì„±)
          # ê¸°ì¡´ READMEì˜ ìƒë‹¨ ê³ ì • ë‚´ìš©ì„ ì—¬ê¸°ì— ì ìœ¼ì„¸ìš”.
          header = '# ğŸš€ Hello, I am sunwkim!\n\n'
          stats = f'\n### ğŸ“Š 42 Stats\n- **Level:** {level}\n- **Blackhole:** {bh}\n- **Campus:** 42 Lausanne\n'
          
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(header + stats)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Update 42 stats" || exit 0
          git push
