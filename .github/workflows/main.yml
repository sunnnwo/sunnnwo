name: Update 42 Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Update README
        env:
          FT_UID: ${{ secrets.FT_UID }}
          FT_SECRET: ${{ secrets.FT_SECRET }}
        run: |
          python -c "
          import os, requests, re
          uid = os.getenv('FT_UID')
          secret = os.getenv('FT_SECRET')
          
          # í† í° ë°œê¸‰
          res_token = requests.post('https://api.intra.42.fr/oauth/token', data={'grant_type': 'client_credentials', 'client_id': uid, 'client_secret': secret})
          token = res_token.json().get('access_token')
          
          # ìœ ì € ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          res_data = requests.get('https://api.intra.42.fr/v2/users/sunwkim', headers={'Authorization': f'Bearer {token}'})
          data = res_data.json()
          
          # ëª¨ë“  ê³¼ì • ì¤‘ ê°€ì¥ ë ˆë²¨ì´ ë†’ì€ ê²ƒ ì„ íƒ (ê³µí†µê³¼ì • í¬í•¨)
          cursus_list = data.get('cursus_users', [])
          if cursus_list:
              best_cursus = max(cursus_list, key=lambda x: x.get('level', 0))
              level = best_cursus.get('level', '0.00')
              bh = (best_cursus.get('blackhole_expiration_date') or 'Completed').split('T')[0]
          else:
              level, bh = '0.00', 'N/A'
          
          stats = f'### ğŸ“Š 42 Stats (sunwkim)\n- **Level:** {level}\n- **Blackhole:** {bh}\n- **Campus:** 42 Lausanne\n'
          
          # README ì½ê¸°
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # ì¤‘ë³µ ì œê±° ë° ì¹˜í™˜ ë¡œì§ (Split ë°©ì‹)
          start_tag = ''
          end_tag = ''
          
          if start_tag in content and end_tag in content:
              before = content.split(start_tag)[0]
              after = content.split(end_tag)[-1]
              new_content = f'{before.strip()}\n\n{start_tag}\n{stats}\n{end_tag}\n\n{after.strip()}'
          else:
              new_content = f'{content.strip()}\n\n{start_tag}\n{stats}\n{end_tag}'
              
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Update 42 stats" || exit 0
          git push
