name: Update 42 Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Update README
        env:
          FT_UID: ${{ secrets.FT_UID }}
          FT_SECRET: ${{ secrets.FT_SECRET }}
        run: |
          python <<EOF
          import os
          import requests
          import re
          import sys

          try:
              # 1. í™˜ê²½ë³€ìˆ˜ í™•ì¸
              uid = os.environ.get('FT_UID')
              secret = os.environ.get('FT_SECRET')
              if not uid or not secret:
                  print("Error: API Keys not found.")
                  sys.exit(1)

              # 2. í† í° ë°œê¸‰
              token_url = "https://api.intra.42.fr/oauth/token"
              payload = {
                  "grant_type": "client_credentials",
                  "client_id": uid,
                  "client_secret": secret
              }
              r = requests.post(token_url, data=payload)
              r.raise_for_status()
              token = r.json()['access_token']

              # 3. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
              user_url = "https://api.intra.42.fr/v2/users/sunwkim"
              headers = {"Authorization": f"Bearer {token}"}
              r = requests.get(user_url, headers=headers)
              r.raise_for_status()
              data = r.json()

              # 4. ê³µí†µ ê³¼ì •(Cursus ID: 21) ì°¾ê¸°
              cursus_users = data.get('cursus_users', [])
              target_cursus = None
              
              # ID 21 ê²€ìƒ‰
              for c in cursus_users:
                  if c.get('cursus_id') == 21:
                      target_cursus = c
                      break
              
              # ì—†ìœ¼ë©´ ê°€ì¥ ë†’ì€ ë ˆë²¨ ì‚¬ìš©
              if target_cursus is None and cursus_users:
                  target_cursus = max(cursus_users, key=lambda x: x.get('level', 0))

              # ì •ë³´ ì¶”ì¶œ (split í•¨ìˆ˜ ì œê±° -> ìŠ¬ë¼ì´ì‹± ì‚¬ìš©)
              if target_cursus:
                  level = target_cursus.get('level', 0)
                  bh_date = target_cursus.get('blackhole_expiration_date')
                  if bh_date is None:
                      bh = "âœ… Completed"
                  else:
                      bh = str(bh_date)[:10] # ë‚ ì§œ ì• 10ìë¦¬ë§Œ ìë¦„
              else:
                  level = "N/A"
                  bh = "N/A"

              # 5. ì¶œë ¥í•  í…ìŠ¤íŠ¸ ë§Œë“¤ê¸°
              stats_content = f"### ğŸ“Š 42 Stats (sunwkim)\n- **Level:** {level}\n- **Blackhole:** {bh}\n- **Campus:** 42 Lausanne"
              
              start_tag = ""
              end_tag = ""
              full_block = f"{start_tag}\n{stats_content}\n{end_tag}"

              # 6. README ì—…ë°ì´íŠ¸ (ì •ê·œì‹
