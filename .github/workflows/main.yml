name: Update 42 Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Update README
        env:
          FT_UID: ${{ secrets.FT_UID }}
          FT_SECRET: ${{ secrets.FT_SECRET }}
        run: |
          python -c "
          import os, requests, re
          uid, secret = os.getenv('FT_UID'), os.getenv('FT_SECRET')
          
          # 1. API Token ë°œê¸‰
          token_res = requests.post('https://api.intra.42.fr/oauth/token', data={'grant_type': 'client_credentials', 'client_id': uid, 'client_secret': secret})
          token = token_res.json().get('access_token')
          
          # 2. ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          user_res = requests.get('https://api.intra.42.fr/v2/users/sunwkim', headers={'Authorization': f'Bearer {token}'})
          data = user_res.json()
          
          # ê³µí†µ ê³¼ì •(id: 21) ì •ë³´ë¥¼ ì°¾ê±°ë‚˜ ê°€ì¥ ë†’ì€ ë ˆë²¨ ì„ íƒ
          cursus_users = data.get('cursus_users', [])
          core_info = next((c for c in cursus_users if c.get('cursus_id') == 21), max(cursus_users, key=lambda x: x.get('level', 0)) if cursus_users else {})
          
          level = core_info.get('level', '0.00')
          bh = (core_info.get('blackhole_expiration_date') or 'Completed').split('T')[0]
          
          stats_text = f'### ğŸ“Š 42 Stats (sunwkim)\n- **Level:** {level}\n- **Blackhole:** {bh}\n- **Campus:** 42 Lausanne\n'
          
          # 3. README.md ì—…ë°ì´íŠ¸ ë¡œì§
          start_tag, end_tag = '', ''
          if os.path.exists('README.md'):
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          else:
              content = ''

          # íƒœê·¸ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ ì‚¬ì´ë¥¼ êµì²´í•˜ê³ , ì—†ìœ¼ë©´ ë§¨ ì•„ë˜ì— ì¶”ê°€í•¨
          pattern = f'{re.escape(start_tag)}.*?{re.escape(end_tag)}'
          replacement = f'{start_tag}\n{stats_text}\n{end_tag}'
          
          if re.search(pattern, content, re.DOTALL):
              new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          else:
              new_content = content.strip() + f'\n\n{replacement}\n'
              
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Update 42 stats" || exit 0
          git push
