name: Update 42 Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Update README
        env:
          FT_UID: ${{ secrets.FT_UID }}
          FT_SECRET: ${{ secrets.FT_SECRET }}
        run: |
          python <<EOF
          import os, requests, sys

          uid = os.getenv('FT_UID')
          secret = os.getenv('FT_SECRET')

          # 1. í† í° ë°œê¸‰
          auth_res = requests.post('https://api.intra.42.fr/oauth/token', data={
              'grant_type': 'client_credentials',
              'client_id': uid,
              'client_secret': secret
          })
          token = auth_res.json().get('access_token')

          # 2. ë°ì´í„° ì¡°íšŒ
          user_res = requests.get('https://api.intra.42.fr/v2/users/sunwkim', 
                                  headers={'Authorization': f'Bearer {token}'})
          data = user_res.json()

          # 3. ë³¸ê³¼ì • ë ˆë²¨ ì°¾ê¸° (Common Core id: 21)
          cursus_list = data.get('cursus_users', [])
          core = next((c for c in cursus_list if c.get('cursus_id') == 21), 
                      max(cursus_list, key=lambda x: x.get('level', 0)) if cursus_list else {})

          level = core.get('level', '0.00')
          # ë¸”ëž™í™€ ë‚ ì§œ ì²˜ë¦¬
          bh_raw = core.get('blackhole_expiration_date')
          bh = bh_raw[:10] if bh_raw else "Completed"

          # 4. README.md íŒŒì¼ ìƒˆë¡œ ì“°ê¸° (Overwrite)
          # ê¸°ì¡´ ë‚´ìš©ì„ ë¬´ì‹œí•˜ê³  ìƒˆë¡œ ìž‘ì„±í•˜ë¯€ë¡œ split ì—ëŸ¬ê°€ ë‚  ìˆ˜ ì—†ìŒ
          readme_content = f"""# ðŸš€ Hello, I am sunwkim!

### ðŸ“Š 42 Stats
- **Level:** {level}
- **Blackhole:** {bh}
- **Campus:** 42 Lausanne
- **Last Updated:** $(date +'%Y-%m-%d')

---
*This profile is automatically updated using 42 API.*
"""
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(readme_content)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Update 42 stats" || exit 0
          git push
